use num_bigint::BigUint;
use num_traits::Zero;
use std::sync::LazyLock;

/// BLS12-381 scalar field modulus
static MODULUS: LazyLock<BigUint> = LazyLock::new(|| {
    "52435875175126190479447740508185965837690552500527637822603658699938581184513"
        .parse()
        .unwrap()
});

/// MiMC round constants (111 constants for BLS12-381)
#[rustfmt::skip]
static CONSTANTS: LazyLock<[BigUint; 111]> = LazyLock::new(|| [
    "13455917033551684388805986546318504194850770935911910752632064517024909471770".parse().unwrap(), // 0
    "36105173743233688698131949103649244090345277209041204920111145905001535976522".parse().unwrap(), // 1
    "4432073145102449319306094609970337344332667434652215431070992817798876885138".parse().unwrap(), // 2
    "10076633742842908130095836781560089881117188938276622901892546550850094816737".parse().unwrap(), // 3
    "796636033841689627732941016044857384234234277501564259311815186813195010627".parse().unwrap(), // 4
    "50826277908896052807607039263888665669592121977576798876911971151186688859055".parse().unwrap(), // 5
    "8344705685278765829729525786869451198465454541218502287970787410927998124522".parse().unwrap(), // 6
    "35998511508388700277878971790839128648971885531453996832238860174110999500586".parse().unwrap(), // 7
    "18183635788335456259215276538456634373878691301055828686319747253615002143747".parse().unwrap(), // 8
    "30323123799904289122080014114571802547699612123170549195354042606042013954036".parse().unwrap(), // 9
    "12947007899973511277335340479072112918759663880454700827376454658238239490287".parse().unwrap(), // 10
    "33371039706946221131896823154266650957676829319224235349015363695502653828989".parse().unwrap(), // 11
    "27784357766073635059728385796861499742120237254666505754545151839970885540792".parse().unwrap(), // 12
    "43160855038523589652640691634167173564245774369944777854664504388420946701066".parse().unwrap(), // 13
    "22994081237509973533016196041260758299947213684402142069502308834504842524074".parse().unwrap(), // 14
    "1320795241461842145682765991710777158129969458638201896235476626192124107670".parse().unwrap(), // 15
    "8231877132811199596376758288825197494440517476607659739835166243301765860904".parse().unwrap(), // 16
    "30223310548319093064739878503818077231292662776236544245657048097083269710716".parse().unwrap(), // 17
    "24070399260623189318973994901723838625475027937022760559079984482266917914918".parse().unwrap(), // 18
    "46995617475566511394300326641238164871541143367719457816773415138333621271747".parse().unwrap(), // 19
    "13285658195944621832380661340215410976335252803984178717370455326094720266840".parse().unwrap(), // 20
    "24951837112955150822420714280003084691491188104457662492267359070982612582724".parse().unwrap(), // 21
    "44798714887565164996336052489647074475980705852117274701961354191356129714933".parse().unwrap(), // 22
    "23136191045676110836006240309618629991309058328625141899547107734177934105284".parse().unwrap(), // 23
    "25918900782734843174006982177422667019760771541425044126903838222457080790762".parse().unwrap(), // 24
    "9456585747207468967136341612034989517427340607940281880317747335469436896657".parse().unwrap(), // 25
    "23784533343015378153006856120966274481837606158712875119035046603369925237333".parse().unwrap(), // 26
    "42759242036062342346688536504139312980212513696502949762681359951122279227201".parse().unwrap(), // 27
    "4136895936904138376202487314907288045120822712541316705628102997930875306009".parse().unwrap(), // 28
    "23149771165716491201920423185401326439934404974454477644507522033938419375958".parse().unwrap(), // 29
    "23695014760607119623043369899422738076382158967206163960603825989257726801270".parse().unwrap(), // 30
    "46013673779249068644868612837662889441038680454184704525526819406675648535145".parse().unwrap(), // 31
    "49936260613467856394876689344648752276855256947718527879134989889891277632770".parse().unwrap(), // 32
    "2159153222189174173490067225063044363535871059524538695070191871847470955412".parse().unwrap(), // 33
    "8366145246467021375422693136401222156713321373077068372411546648701944063037".parse().unwrap(), // 34
    "6396814763006431142778018052709382845229317990616980942304853341406226457497".parse().unwrap(), // 35
    "1528918281647336706687602488146634419827880017304652873443814617913125329787".parse().unwrap(), // 36
    "49787234927188522622322107555384700074367351894124720727557178620562534391947".parse().unwrap(), // 37
    "1255107154975108514881995629693509987810827346166880729138247132732398800605".parse().unwrap(), // 38
    "15131843848025795638266843204265591494253098765900322051547200938371934655740".parse().unwrap(), // 39
    "5056480146405086811789505170440731715530475328844870175949109998024731067467".parse().unwrap(), // 40
    "37628669125748141255858804556043629663603700493080743476086886521178409664319".parse().unwrap(), // 41
    "22379493041209909337294800237323296776350200286970403006721311082791718194262".parse().unwrap(), // 42
    "49032225639651844112524374030073760153036978285463701695560534780433245223849".parse().unwrap(), // 43
    "38110970679723360475519008450141696452914286810864353460220054282487073141682".parse().unwrap(), // 44
    "14632768325173884283300566709823675743961290053851644736464114177500335953414".parse().unwrap(), // 45
    "48031152672724269833302578109003566707023380763879583289459553516882312508784".parse().unwrap(), // 46
    "38034500677019077453732302061203984249164270741599160624390649349339022623393".parse().unwrap(), // 47
    "34012956866342066012820392426940783539407814856900218522068350312351319932747".parse().unwrap(), // 48
    "1316449090346410801845183915381769525990226349513436734911941391785200212382".parse().unwrap(), // 49
    "11231642642905482716413162879048407479059070481321080260598797846706122664059".parse().unwrap(), // 50
    "27703289250348329807600342298890287349371575249526359663711151044583275024741".parse().unwrap(), // 51
    "22571521386477356940523768733058560532247960914871341499561156735054027530831".parse().unwrap(), // 52
    "16449119652784672018453279488577293032638547027392355044846778114889744933505".parse().unwrap(), // 53
    "18358340181373245742856489324878059500109083493563555654399279196194914986550".parse().unwrap(), // 54
    "1706109811034862652960543598274606674872119241962072244804811880727743479090".parse().unwrap(), // 55
    "9180539993475470715702819756442883463424861615500635439640905447184335686321".parse().unwrap(), // 56
    "47391540669267957143263102893686206242961541208859215663379082509044306791343".parse().unwrap(), // 57
    "46220507494397991460322008572454961645000370540482720081569452719902337199420".parse().unwrap(), // 58
    "15143675381185307178500906868356334825651015737618718091251777377451213407009".parse().unwrap(), // 59
    "47415440798220926943548095142160577154144876089871364214816891050887464045880".parse().unwrap(), // 60
    "13636645527353090761427433756944006191318857406146294409351154576499989074448".parse().unwrap(), // 61
    "49803591768919235765767576335918155487135075124798916395995957388475682420563".parse().unwrap(), // 62
    "40840098604968650221786229983895110373264039096483978744472874474336582716562".parse().unwrap(), // 63
    "51451207546620505708731684375583768757747127270062013142821200942522312599514".parse().unwrap(), // 64
    "19623255796206582213343044956093476486139104852525580813879681620362890897558".parse().unwrap(), // 65
    "32513819260885919409774160716227575451809963545571602646885448127932366136971".parse().unwrap(), // 66
    "18271032611473066518574379295246725343109497835170563683555810856652610569038".parse().unwrap(), // 67
    "32304490791332157908773205399708511468936592681224015130543971203667015590197".parse().unwrap(), // 68
    "46872582347573239566160029350047577399737869653706660550801940202634780189074".parse().unwrap(), // 69
    "4224413053359434807569447660538804578348675818917444457557076663663520243836".parse().unwrap(), // 70
    "45097922981878279971946975628210957236349432610214193115770677741544707909567".parse().unwrap(), // 71
    "28925663492115069366812369529967921311078457164221145003350529650800182871746".parse().unwrap(), // 72
    "51827537454777180323994723343379981201169664299476821905051208437827506055814".parse().unwrap(), // 73
    "38672404987675649017981611270998991485637379892220839399888622694204498010547".parse().unwrap(), // 74
    "3600278227964710138244382395698346272046091699146154538484570942359304343365".parse().unwrap(), // 75
    "23828541255005299790050306622437619159673907082685772631950685291081519264507".parse().unwrap(), // 76
    "18092495413286015678790630168208787644418599959399842781132549515553139410584".parse().unwrap(), // 77
    "8281263925518236627757103541847237517086230172623051810302850712557851432991".parse().unwrap(), // 78
    "8448063354721769817902459808726146712448920033372308093934143713043950744991".parse().unwrap(), // 79
    "27109930081907039442588969686490074234814196180995484920678499447343448878496".parse().unwrap(), // 80
    "43689318308109817855877188240646097376459584050476678639865858128251723789373".parse().unwrap(), // 81
    "35139113304807065339045832828073755423845009535485603158211951310500042292252".parse().unwrap(), // 82
    "23650644224881775331537571419725579292695111422172599325469137724382933814731".parse().unwrap(), // 83
    "7637907586055940881746550270606881871499306561281721837109497146132490638703".parse().unwrap(), // 84
    "2642152591696505726583357170929470430913985263242151589269405978573127649865".parse().unwrap(), // 85
    "16455316775738428157495784461784259649533800783035454165492743673709497942877".parse().unwrap(), // 86
    "882700507159935720943118399658325854660412964012347429176422037985115882258".parse().unwrap(), // 87
    "23310019676472164725496705415405263215275747941103713297290919466430309290976".parse().unwrap(), // 88
    "3912027174088099540771427101094323472540269665880953189112136899729225711553".parse().unwrap(), // 89
    "26779125443551946723851966842526272845327846440580868972886303134451813221033".parse().unwrap(), // 90
    "10163406568392002086458658037379973320888055131825551173829633152008526239762".parse().unwrap(), // 91
    "11198961888624850740946105815368309038615496837175352239432238918070711465853".parse().unwrap(), // 92
    "11909653872466441525776090047727041987012741917206561105320879272791628035689".parse().unwrap(), // 93
    "1420374220234815122784699216957113842453134975436220082912418021695276802610".parse().unwrap(), // 94
    "33964049835590489294487429421371055682565062827655160564724423127453829089716".parse().unwrap(), // 95
    "38831954547416159208874855738227253512222803423237438301408058302325519592408".parse().unwrap(), // 96
    "6218831960903649756769607751293234186011544673685676795088558391636349217558".parse().unwrap(), // 97
    "25186633352157121843936165876916706371268246117244688775889438865799004246794".parse().unwrap(), // 98
    "23355615106085856913886316189095075363012643640135114474222706041996377427179".parse().unwrap(), // 99
    "7686344415884195068434388787471594459297892146591927259578945339164184879051".parse().unwrap(), // 100
    "51225322309228945023116618006592417857969520015827493424888152626033586925129".parse().unwrap(), // 101
    "21879478495006705672180486170487961960507706458195501864494732167763464429025".parse().unwrap(), // 102
    "25136507268427331851005620250569728639145260226529737023109590917210178817869".parse().unwrap(), // 103
    "38003332257348502234309692438166939851311319381443469349256898216075586673698".parse().unwrap(), // 104
    "24146736275901410142745382316434335210799709017123120835849837102831185753380".parse().unwrap(), // 105
    "33200692291719979593409875133368672092338301284613332360968325668743663110382".parse().unwrap(), // 106
    "946846991220209476320034264891531747089512397162778313999372941779941945739".parse().unwrap(), // 107
    "2882443813127861895205010344014631301476578399898408905078146194748453268764".parse().unwrap(), // 108
    "27910528068982011758503915580268485941549499303766285354722179016540609454692".parse().unwrap(), // 109
    "22788191563125794378649362095042023485357702798552706035706526724068908249030".parse().unwrap(), // 110
]);

fn field_add(a: &BigUint, b: &BigUint) -> BigUint {
    (a + b) % &*MODULUS
}

fn field_mul(a: &BigUint, b: &BigUint) -> BigUint {
    (a * b) % &*MODULUS
}

/// MiMC encrypt: 111 rounds of (x + h + C[i])^5, then + h
fn encrypt(m: &BigUint, h: &BigUint) -> BigUint {
    let mut x = m.clone();
    for c in CONSTANTS.iter() {
        let t = field_add(&field_add(&x, h), c);
        let t2 = field_mul(&t, &t);
        let t4 = field_mul(&t2, &t2);
        x = field_mul(&t4, &t);
    }
    field_add(&x, h)
}

/// MiMC checksum using Miyaguchi-Preneel construction
fn checksum(data: &[BigUint], h: &BigUint) -> BigUint {
    let mut h_state = h.clone();
    for d in data {
        let r = encrypt(d, &h_state);
        h_state = field_add(&field_add(&r, &h_state), d);
    }
    h_state
}

/// MiMC hash (equivalent to MiMC_Sum in circom).
/// Each input message is a big-endian 32-byte field element.
pub fn mimc_sum(msgs: &[[u8; 32]]) -> [u8; 32] {
    let field_msgs: Vec<BigUint> = msgs.iter().map(|m| BigUint::from_bytes_be(m)).collect();
    let h = BigUint::zero();
    let result = checksum(&field_msgs, &h);

    let bytes = result.to_bytes_be();
    let mut out = [0u8; 32];
    let start = 32 - bytes.len();
    out[start..].copy_from_slice(&bytes);
    out
}

#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_match_avm() {
        let expected: BigUint =
            "49105172669127360405434456472687549054927962593265498033454743191558675115881"
                .parse()
                .unwrap();

        let inputs = [13, 37].map(|x| {
            let mut arr = [0u8; 32];
            arr[31] = x;
            arr
        });

        let result = BigUint::from_bytes_be(&mimc_sum(&inputs));
        assert_eq!(result, expected);
    }

    #[test]
    fn test_single_zero() {
        let msg = [0u8; 32];
        let result = mimc_sum(&[msg]);
        // Sanity: hashing a single zero should produce a non-zero result
        assert_ne!(result, [0u8; 32]);
    }

    #[test]
    fn test_deterministic() {
        let msg = [0u8; 32];
        let r1 = mimc_sum(&[msg]);
        let r2 = mimc_sum(&[msg]);
        assert_eq!(r1, r2);
    }

    #[test]
    fn test_different_inputs_different_outputs() {
        let mut msg1 = [0u8; 32];
        msg1[31] = 1;
        let mut msg2 = [0u8; 32];
        msg2[31] = 2;
        assert_ne!(mimc_sum(&[msg1]), mimc_sum(&[msg2]));
    }

    #[test]
    fn test_multi_message() {
        let mut msg1 = [0u8; 32];
        msg1[31] = 1;
        let mut msg2 = [0u8; 32];
        msg2[31] = 2;
        // Hash of [m1, m2] should differ from hash of [m1] or [m2]
        let h12 = mimc_sum(&[msg1, msg2]);
        let h1 = mimc_sum(&[msg1]);
        let h2 = mimc_sum(&[msg2]);
        assert_ne!(h12, h1);
        assert_ne!(h12, h2);
    }
}
